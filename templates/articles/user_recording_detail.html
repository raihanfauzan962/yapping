{% extends "_base.html" %}
{% load static %}

{% block content %}
<h1>Recording Details</h1>

<p><strong>Article:</strong> {{ recording.article.title }}</p>
<p><strong>Submitted At:</strong> {{ recording.submitted_at }}</p>

<h2>Audio</h2>
<audio controls>
    <source src="{{ recording.audio_file.url }}" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<h2>Transcript</h2>
<p style="text-align: justify;">{{ recording.transcript|default:"No transcript available" }}</p>

<h2>Scores</h2>
<ul style="text-align: justify;">
    <li>
        <strong>AI Given Pronunciation Score:</strong> 
        {% if recording.pronunciation_score %}
            <span style="font-size: 3em; font-weight: bold;">
                {{ recording.pronunciation_score|floatformat:0 }}%
            </span>
        {% else %}
            N/A
        {% endif %}
    </li>        
    <li>
        <strong>AI Feedback:<br></strong> 
        <p style="font-size: 0.9em; color: grey; margin-top: 5px;">
            This feedback is autogenerated by AI and includes your incorrectly pronounced words along with the suggested correct words.
        </p>
        {{ recording.feedback|default:"No feedback provided yet"|linebreaksbr }}
        {% if recording.feedback %}
        {% endif %}
    </li>    
</ul>

<h2>Highlighted Transcript</h2>
<p style="color: grey; text-align: justify;"><i>The red highlighted words are the ones you mistakenly pronounce.</i></p>
{% if recording.highlighted_transcript %}
    <div style="text-align: justify;">
        {% autoescape off %}
        {{ recording.highlighted_transcript|default:"No highlighted transcript available" }}
        {% endautoescape %}
    </div>
{% else %}
    <p style="text-align: justify;">No highlighted transcript available.</p>
{% endif %}

<h2>Highlighted Article</h2>
<p style="color: grey; text-align: justify;"><i>And these green ones are the correct words you should pronounce.<br>
    Click on the green word to hear the correct pronunciation.</i></p>
{% if recording.highlighted_article %}
    <div style="text-align: justify;">
        {% autoescape off %}
        {{ recording.highlighted_article|default:"No highlighted article available" }}
        {% endautoescape %}
    </div>
{% else %}
    <p style="text-align: justify;">No highlighted article available.</p>
{% endif %}

{% if recording.feedback_recording %}
<h2>Detailed Feedback</h2>
<ul>
    <li><strong>Evaluator:</strong> {{ recording.feedback_recording.evaluator }}</li>
    <li><strong>Pronunciation Score:</strong> {{ recording.feedback_recording.pronunciation_score }}</li>
    <li><strong>Intonation Score:</strong> {{ recording.feedback_recording.intonation_score }}</li>
    <li><strong>Fluency Score:</strong> {{ recording.feedback_recording.fluency_score }}</li>
    <li><strong>Overall Score:</strong> {{ recording.feedback_recording.overall_score }}</li>
    <li><strong>Comments:</strong> {{ recording.feedback_recording.comments|linebreaksbr }}</li>
</ul>
{% else %}
<br><p>No detailed feedback available yet.</p>
{% endif %}

<a href="{% url 'user_recording_list' %}">Back to your recordings</a>

<!-- Add TTS JavaScript -->
<script>
    // Function to handle TTS playback
    function playTTS(word) {
        // Make a new audio element and play it
        const audio = new Audio(`/articles/text-to-speech/?word=${encodeURIComponent(word)}`);
        
        // Ensure the audio can be played
        audio.play().catch(error => {
            console.error("Error playing audio:", error);
            alert("Unable to play the sound. Please check your browser settings.");
        });
    }

    // Attach event listeners to green-highlighted words
    document.addEventListener('DOMContentLoaded', function () {
        // Find all green-highlighted words (from your backend-highlighted content)
        document.querySelectorAll('span[style="color: green;"]').forEach(function (span) {
            // Make the green text clickable
            span.style.cursor = "pointer";

            // Add click event listener
            span.addEventListener('click', function () {
                const word = this.textContent.trim(); // Get the word from the clicked span
                playTTS(word); // Call the TTS playback function
            });
        });
    });
</script>


{% endblock %}
